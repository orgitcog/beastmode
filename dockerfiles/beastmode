# Beast Mode - MS Graph & GitHub Enterprise Automation Toolkit
# Based on Debian Bookworm for WebVM compatibility
FROM --platform=i386 i386/debian:bookworm

ARG DEBIAN_FRONTEND=noninteractive

# Update and install base packages
RUN apt-get clean && apt-get update && apt-get -y upgrade

# Install essential tools and development packages
RUN apt-get -y install \
    apt-utils \
    bash \
    ca-certificates \
    curl \
    dialog \
    file \
    fakeroot \
    git \
    hexedit \
    jq \
    less \
    lua5.4 \
    luajit \
    make \
    manpages \
    nano \
    netcat-openbsd \
    nodejs \
    patch \
    python3 \
    python3-pip \
    python3-venv \
    ruby \
    unzip \
    vim \
    wget \
    whiptail

# Install Python packages for MS Graph and API operations
RUN pip3 install --break-system-packages \
    requests \
    python-dotenv \
    tabulate

# Create user
RUN useradd -m user && echo "user:password" | chpasswd

# Create Beast Mode toolkit directory
RUN mkdir -p /home/user/beastmode/scripts \
    && mkdir -p /home/user/beastmode/config \
    && mkdir -p /home/user/beastmode/docs

# Copy Beast Mode toolkit files
COPY --chown=user:user ./beastmode /home/user/beastmode/

# Copy examples
COPY --chown=user:user ./examples /home/user/examples
RUN chmod -R +x /home/user/examples/lua 2>/dev/null || true

# Set permissions
RUN chmod -R +x /home/user/beastmode/scripts 2>/dev/null || true
RUN chmod +x /home/user/beastmode/welcome.sh 2>/dev/null || true
RUN chown -R user:user /home/user/beastmode

# Add Beast Mode to bashrc
RUN cat /home/user/beastmode/bashrc_additions >> /home/user/.bashrc

# Set working directory
WORKDIR /home/user/

# Environment variables
ENV HOME="/home/user" \
    TERM="xterm" \
    USER="user" \
    SHELL="/bin/bash" \
    EDITOR="vim" \
    LANG="en_US.UTF-8" \
    LC_ALL="C" \
    BEASTMODE_HOME="/home/user/beastmode"

# Set root password
RUN echo 'root:password' | chpasswd

# Default command
CMD [ "/bin/bash", "--login" ]
